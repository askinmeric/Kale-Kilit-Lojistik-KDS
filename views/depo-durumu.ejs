<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8"><title>Depo Kapasite | Kale Kilit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --kale-red: #DC143C; --bg-dark: #0a0a0a; --card-bg: #141414; }
        body { background-color: var(--bg-dark); font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #eee; overflow-x: hidden; }
        .sidebar { width: 250px; height: 100vh; position: fixed; background: #000; border-right: 1px solid #222; z-index: 1000; }
        .main-content { margin-left: 250px; padding: 1.5rem; }
        
        .nav-link { 
            color: #aaa !important; padding: 12px 20px; display: flex; 
            align-items: center; text-decoration: none; border-left: 4px solid transparent; 
            transition: 0.3s; font-size: 0.9rem !important; 
        }
        .nav-link.active { color: #fff !important; background: rgba(220, 20, 60, 0.1); border-left-color: var(--kale-red); }
        
        .chart-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid #222; margin-bottom: 2rem; }
        .filter-select { background: #1a1a1a; color: #fff; border: 1px solid #333; font-size: 0.8rem; padding: 5px 15px; border-radius: 4px; outline: none; }
        .progress-kale { background-color: #222; height: 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-4 text-center"><h5 class="fw-bold text-white mb-0">KALE KİLİT</h5><small class="text-danger">DEPO YÖNETİMİ</small></div>
    <nav class="nav flex-column mt-3">
        <a class="nav-link" href="/"><i class="bi bi-speedometer2 me-2"></i> Ana Sayfa</a>
        <a class="nav-link" href="/maliyet-trendi"><i class="bi bi-truck me-2"></i> Taşıma Maliyet Trendi</a>
        <a class="nav-link active" href="/depo-kapasite"><i class="bi bi-box-seam me-2"></i> Depo Kapasite Durumu</a>
        <a class="nav-link" href="/tedarikci-analizi"><i class="bi bi-people me-2"></i> Tedarikçi Performans Analizi</a>
        <a class="nav-link" href="/teslimat-performansi"><i class="bi bi-clock-history me-2"></i> Teslimat Performansı</a>
        <a class="nav-link" href="/sezonluk-is-yuku"><i class="bi bi-bar-chart-steps me-2"></i> Sezonluk İş Yükü</a>
    </nav>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0 text-uppercase"><i class="bi bi-box-seam text-danger me-2"></i> Depo Kapasite Durumu</h4>
        <select id="depoSecici" class="filter-select" onchange="loadDepoDetails()">
            <option value="">Tüm Depolar</option>
        </select>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="chart-card">
                <h6 class="fw-bold text-uppercase mb-4 small opacity-75">Depo Bazlı Doluluk Oranları</h6>
                <div id="depoListe"></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="chart-card">
                <h6 class="fw-bold text-uppercase mb-4 small opacity-75">Ürün Dağılım Analizi</h6>
                <div style="height: 300px;"><canvas id="urunChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let uChart;

    async function loadDepoDetails() {
        const dId = document.getElementById('depoSecici').value;
        const res = await fetch(`/api/dashboard/all-stats?depoId=${dId}`);
        const data = await res.json();

        // 1. Depo Dropdown'ını Doldur (Sadece ilk yüklemede)
        const dSec = document.getElementById('depoSecici');
        if(dSec.options.length === 1 && data.depolarList) {
            data.depolarList.forEach(d => dSec.add(new Option(d.DepoAdi, d.DepoId)));
        }

        // 2. Depo Listesi ve Progress Barlar
        document.getElementById('depoListe').innerHTML = data.depoKapasite.map(d => `
            <div class="mb-4">
                <div class="d-flex justify-content-between small mb-1">
                    <span class="fw-bold">${d.Isim}</span>
                    <span class="fw-bold ${parseFloat(d.Oran)>85?'text-danger':'text-success'}">%${d.Oran}</span>
                </div>
                <div class="progress progress-kale"><div class="progress-bar" style="width:${d.Oran}%; background-color:${parseFloat(d.Oran)>85?'#DC143C':'#28a745'}"></div></div>
            </div>
        `).join('');

        // 3. Ürün Dağılım Analizi Grafiği (Düzeltildi)
        if(uChart) uChart.destroy();
        uChart = new Chart(document.getElementById('urunChart'), {
            type: 'doughnut',
            data: {
                labels: data.urunDagilimi.map(x => x.Kategori),
                datasets: [{
                    data: data.urunDagilimi.map(x => x.Miktar),
                    backgroundColor: ['#DC143C', '#28a745', '#00d4ff', '#ffc107', '#6f42c1'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#aaa', font: { size: 11 } } } } }
        });
    }

    window.onload = loadDepoDetails;
</script>
</body>
</html>