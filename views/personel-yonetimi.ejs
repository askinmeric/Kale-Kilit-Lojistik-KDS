<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8"><title>Personel Yönetimi | Kale Kilit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --kale-red: #DC143C; --bg-dark: #0a0a0a; --card-bg: #141414; }
        body { background-color: var(--bg-dark); font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #eee; }
        .sidebar { width: 250px; height: 100vh; position: fixed; background: #000; border-right: 1px solid #222; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .nav-link { color: #aaa !important; padding: 12px 20px; display: flex; align-items: center; text-decoration: none; border-left: 4px solid transparent; font-size: 0.9rem !important; }
        .nav-link.active { color: #fff !important; background: rgba(220, 20, 60, 0.1); border-left-color: var(--kale-red); }
        .chart-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid #222; margin-bottom: 2rem; }
        .form-control, .form-select { background-color: #1a1a1a; border: 1px solid #333; color: #fff; font-size: 0.9rem; }
        .form-control:focus { background-color: #222; border-color: var(--kale-red); color: #fff; box-shadow: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-4 text-center"><h5 class="fw-bold text-white mb-0">KALE KİLİT</h5><small class="text-danger">PERSONEL YÖNETİMİ</small></div>
    <nav class="nav flex-column mt-3">
        <a class="nav-link" href="/"><i class="bi bi-speedometer2 me-2"></i> Ana Sayfa</a>
        <a class="nav-link active" href="/personel-yonetimi"><i class="bi bi-person-gear me-2"></i> Personel Yönetimi</a>
    </nav>
</div>

<div class="main-content">
    <div class="row">
        <div class="col-lg-4">
            <div class="chart-card">
                <h6 class="fw-bold text-uppercase mb-4 small"><i class="bi bi-plus-circle me-2"></i> Yeni Personel Kaydı</h6>
                <form id="personelForm">
                    <div class="mb-3">
                        <label class="form-label small opacity-75">Ad Soyad</label>
                        <input type="text" id="ad_soyad" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small opacity-75">Bölge</label>
                        <select id="bolge" class="form-select">
                            <option value="Marmara">Marmara Bölgesi</option>
                            <option value="Ege">Ege Bölgesi</option>
                            <option value="İç Anadolu">İç Anadolu Bölgesi</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small opacity-75">Başarı Oranı (%)</label>
                        <input type="number" id="basari_orani" class="form-control" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small opacity-75">Risk Puanı (Max 100)</label>
                        <input type="number" id="risk_puani" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-danger w-100 fw-bold py-2">KAYDET</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="chart-card">
                <h6 class="fw-bold text-uppercase mb-4 small"><i class="bi bi-table me-2"></i> Aktif Lojistik Personelleri</h6>
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle small">
                        <thead>
                            <tr class="text-secondary border-secondary">
                                <th>AD SOYAD</th>
                                <th>BÖLGE</th>
                                <th>BAŞARI</th>
                                <th>RİSK</th>
                                <th>İŞLEM</th>
                            </tr>
                        </thead>
                        <tbody id="personelListesi"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // 1. LİSTELEME (READ)
    async function loadPersonel() {
        const res = await fetch('/api/personel');
        const data = await res.json();
        const tbody = document.getElementById('personelListesi');
        tbody.innerHTML = data.map(p => `
            <tr>
                <td class="fw-bold">${p.ad_soyad}</td>
                <td><span class="badge bg-dark border border-secondary">${p.bolge}</span></td>
                <td>%${p.basari_orani}</td>
                <td><span class="text-${p.risk_puani > 80 ? 'danger' : 'success'}">${p.risk_puani}</span></td>
                <td><button onclick="deletePersonel(${p.id})" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></td>
            </tr>
        `).join('');
    }

    // 2. EKLEME (CREATE - İş Kuralı 1 Testi)
    document.getElementById('personelForm').onsubmit = async (e) => {
        e.preventDefault();
        const body = {
            ad_soyad: document.getElementById('ad_soyad').value,
            bolge: document.getElementById('bolge').value,
            basari_orani: document.getElementById('basari_orani').value,
            risk_puani: document.getElementById('risk_puani').value
        };

        const res = await fetch('/api/personel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        if (res.ok) {
            Swal.fire('Başarılı!', data.message, 'success');
            loadPersonel();
            e.target.reset();
        } else {
            // İş kuralı hatasını burada gösteririz (Risk > 100)
            Swal.fire('Hata!', data.error, 'error');
        }
    };

    // 3. SİLME (DELETE - İş Kuralı 2 Testi)
    async function deletePersonel(id) {
        const confirm = await Swal.fire({
            title: 'Emin misiniz?',
            text: "Bu personeli silmek istediğinize emin misiniz?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#DC143C',
            cancelButtonColor: '#333',
            confirmButtonText: 'Evet, Sil'
        });

        if (confirm.isConfirmed) {
            const res = await fetch(`/api/personel/${id}`, { method: 'DELETE' });
            const data = await res.json();
            
            if (res.ok) {
                Swal.fire('Silindi!', data.message, 'success');
                loadPersonel();
            } else {
                // İş kuralı hatasını burada gösteririz (%100 Başarı silinemez)
                Swal.fire('Engel!', data.error, 'error');
            }
        }
    }

    window.onload = loadPersonel;
</script>
</body>
</html>