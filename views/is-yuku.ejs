<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Sezonluk İş Yükü Analizi | Kale Kilit</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root { 
            --kale-red: #DC143C; 
            --kale-red-soft: rgba(220, 20, 60, 0.15);
            --bg-dark: #0a0a0a; 
            --card-bg: #141414; 
            --info-blue: #00d4ff;
        }
        
        body { 
            background-color: var(--bg-dark); 
            font-family: 'Segoe UI', sans-serif; 
            font-size: 14px; /* 0.9rem standardı */
            color: #eee; 
            margin: 0;
            overflow-x: hidden; 
        }

        /* Sabit Sidebar Tasarımı */
        .sidebar { 
            width: 250px; height: 100vh; position: fixed; 
            top: 0; left: 0;
            background: #000; border-right: 1px solid #222; z-index: 1000; 
        }
        
        .sidebar-brand { padding: 1.5rem; text-align: center; border-bottom: 1px solid #111; }

        .nav-link { 
            color: #aaa !important; padding: 12px 20px; display: flex; align-items: center; 
            text-decoration: none; border-left: 4px solid transparent; 
            transition: 0.2s all; font-size: 0.9rem !important; 
        }

        .nav-link:hover { color: #fff !important; background: rgba(255,255,255,0.03); }
        .nav-link.active { color: #fff !important; background: var(--kale-red-soft); border-left-color: var(--kale-red); }

        /* Ana İçerik Alanı */
        .main-content { margin-left: 250px; padding: 2rem; }

        .chart-card { 
            background: var(--card-bg); border-radius: 12px; 
            padding: 1.5rem; border: 1px solid #222; margin-bottom: 1.5rem; 
        }
        
        .card-header-flex {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
        }

        .card-title { 
            font-size: 0.75rem; font-weight: 700; color: #666; 
            text-transform: uppercase; letter-spacing: 0.5px; margin: 0;
        }

        /* Stratejik Analiz Kutusu (Görüntü 291) */
        .alert-kds { 
            background: rgba(255, 193, 7, 0.05); 
            border: 1px solid rgba(255, 193, 7, 0.2); 
            border-radius: 12px; padding: 1.5rem; 
        }

        .alert-title {
            color: #ffc107; font-weight: 700; font-size: 0.85rem; 
            text-transform: uppercase; margin-bottom: 0.75rem; display: flex; align-items: center;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-brand">
        <h5 class="fw-bold text-white mb-0">KALE KİLİT</h5>
        <small class="text-danger text-uppercase small" style="letter-spacing: 1px;">Lojistik KDS</small>
    </div>
    <nav class="nav flex-column mt-3">
        <a class="nav-link" href="/"><i class="bi bi-speedometer2 me-2"></i> Ana Sayfa</a>
        <a class="nav-link" href="/maliyet-trendi"><i class="bi bi-truck me-2"></i> Taşıma Maliyet Trendi</a>
        <a class="nav-link" href="/depo-kapasite"><i class="bi bi-box-seam me-2"></i> Depo Kapasite Durumu</a>
        <a class="nav-link" href="/tedarikci-analizi"><i class="bi bi-people me-2"></i> Tedarikçi Performans Analizi</a>
        <a class="nav-link" href="/teslimat-performansi"><i class="bi bi-clock-history me-2"></i> Teslimat Performansı</a>
        <a class="nav-link active" href="/sezonluk-is-yuku"><i class="bi bi-bar-chart-steps me-2"></i> Sezonluk İş Yükü</a>
    </nav>
</div>

<div class="main-content">
    <div class="chart-card">
        <div class="card-header-flex">
            <h6 class="card-title"><i class="bi bi-graph-up text-info me-2"></i> Sezonluk İş Yükü Dağılımı (12 Aylık)</h6>
            <span class="badge rounded-pill" style="background: rgba(220, 20, 60, 0.2); color: var(--kale-red); border: 1px solid var(--kale-red);">
                Kapasite Sınırı: 95
            </span>
        </div>
        <div style="height: 400px; width: 100%;">
            <canvas id="isYukuChart"></canvas>
        </div>
    </div>

    <div class="alert-kds">
        <div class="alert-title">
            <i class="bi bi-lightbulb-fill me-2"></i> Stratejik İş Yükü Analizi
        </div>
        <p class="mb-0 text-white-50 leading-relaxed" style="font-size: 0.9rem;">
            Veritabanından alınan 12 aylık verilere göre; <b>Mayıs, Haziran ve Eylül</b> aylarında iş yükünün 95 birimlik kapasite sınırını aştığı gözlemlenmiştir. 
            Bu dönemlerde sevkiyat gecikmelerini önlemek adına personel vardiya sayısının artırılması veya ek araç tedariği yapılması önerilmektedir. 
            Özellikle <b>Haziran</b> ayındaki %98'lik yoğunluk, operasyonel risk puanını "Yüksek" seviyeye çekmektedir.
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function initPage() {
        try {
            const res = await fetch('/api/dashboard/all-stats');
            const data = await res.json();

            const ctx = document.getElementById('isYukuChart').getContext('2d');
            
            // Çizgi grafiği için degrade (gradient) oluşturma
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 212, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 212, 255, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.isYuku.map(x => x.Ay),
                    datasets: [
                        {
                            label: 'İş Yükü Miktarı',
                            data: data.isYuku.map(x => x.Toplam),
                            borderColor: '#00d4ff',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#00d4ff',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Kapasite Sınırı (95)',
                            data: Array(data.isYuku.length).fill(95),
                            borderColor: '#DC143C',
                            borderDash: [8, 4],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#888', font: { size: 12 }, padding: 20 }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#fff',
                            bodyColor: '#00d4ff',
                            borderColor: '#333',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 110,
                            grid: { color: '#222' },
                            ticks: { color: '#666', stepSize: 20 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });

        } catch (err) {
            console.error("Grafik yüklenirken hata oluştu:", err);
        }
    }

    window.onload = initPage;
</script>
</body>
</html>